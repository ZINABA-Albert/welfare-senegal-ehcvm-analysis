---
title: "Projet_Merge_Bases"
author: "Albert ZINABA"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    number_sections: true
  word_document:
    toc: true
  pdf_document:
    toc: true
---

```{r setup, include=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

L‚ÄôEnqu√™te Harmonis√©e sur les Conditions de Vie des M√©nages (EHCVM) est une initiative de l‚ÄôUEMOA visant √† am√©liorer la comparabilit√© des indicateurs de pauvret√© et des conditions de vie dans ses √âtats membres. Le S√©n√©gal a particip√© √† cette enqu√™te √† travers deux √©ditions, en 2018 et en 2021. Dans ce travail il nous ait demand√© de faire la fusion des bases welfares presentes dan les deux ann√©es.Pour ce faire, il est essentiel d‚Äôeffectuer un travail pr√©alable de nettoyage, de recodage et d‚Äôharmonisation avant leur fusion. Ce processus garantira la coh√©rence et la comparabilit√© des variables pour la fusion.


*Importations et Chargement des packages*

```{r, message=FALSE, warning=FALSE}
packages <- c("readr","cardx","haven","utils","dplyr","gtsummary","gt" , "DataExplorer","labelled","survey")


for (package in packages) {
  if (!requireNamespace(package, quietly = TRUE)) {   # V√©rifie si le package n'est pas encore install√©
    install.packages(package)
  }
  library(package, character.only = TRUE) # nom du package en nom ou chaine de caract√®re ()
}
```


# Importation et analyse des bases de donn√©es 

Le travail coonsiste a faire la merge des bases de donn√©e welfare de l'EHCVM 2018 et 2021. Mais avant de faire le merge il est essentiel de passer au netoyage des deux base de donn√©es. Cet netoyage part du recodage des variables, la labelisation de certaines variables en tout a l'harmonisation des deux base de donn√©es.

## *Importation des bases de donn√©es*

```{r}
#Nous importons les bases de donn√©es avec la fonction read_dta du package haven

data_welf2018 <- haven::read_dta("../Donnees/ehcvm_welfare_SEN2018.dta") #base welfare 2018
data_welf2021 <- haven::read_dta("../Donnees/ehcvm_welfare_sen2021.dta") #base welfare 2021
```


## *Analyse des bases de donn√©es*

###**Structure de la base de donn√©es des deux bases**

Nous affichons la structure des bases afin d'avoir une vue globale des deux bases 
```{r}
utils::str(data_welf2018) #Structure de la base 2018
utils::str(data_welf2021) #Structure de la base 2021
```


###**Affichages des premieres lignes des deux bases**

Nous affichons les premi√®res lignes des deux bases afin de se faire une id√©e de leurs observations
```{r}
head(data_welf2018)
head(data_welf2021)
```


###**Affichage de quelques statistiques des deux bases**

Il s'agit d'afficher un r√©sum√© statistique des variables contenues dans les bases de donn√©es.
```{r}
summary(data_welf2018)
summary(data_welf2021)
```


###**Verification des doublons** 

Nous verifions pour d√©tecter et compter les m√©nages dupliqu√©s dans les bases de donn√©es.
```{r}

doublon_2018 <- data_welf2018[duplicated(data_welf2018[, c("grappe","menage")]), ] # s√©lectionne les m√©nages dupliqu√© qui sont dans la base 2018

doublon_2021 <- data_welf2021[duplicated(data_welf2021[, c("grappe","menage")]), ] # s√©lectionne les m√©nages dupliqu√© qui sont dans la base 2021

cat("Nombre de doublons pr√©sents dans la base welfare 2018  :", nrow(doublon_2018), "\n")

cat("Nombre de doublons pr√©sents dans la base welfare 2021  :", nrow(doublon_2021))

```


###**verification des valeurs manquantes**

Il s'agit d'afficher les valeurs manquantes pour chacune des deux bases de donn√©es 
```{r}
# Calculer le nombre de valeurs manquantes par variable (colonne)
print("Valeurs manquante base 2018")
NA_base_2018 <- colSums(is.na(data_welf2018))
NA_base_2018

print("Valeurs manquante base 2021")
NA_base_2021 <- colSums(is.na(data_welf2018))
NA_base_2021

```


## *Visualisations des observations des deux bases*

###**Affichage des observations**

Nous extrayons les noms des variables pr√©sentes dans chacune des bases de donn√©es, cela nous permet d'avoir une vue globale des variables des deux bases de donn√©es
```{r}
vars_2018 <- colnames(data_welf2018) # liste les variables dans la base 2018
vars_2021 <- colnames(data_welf2021) # liste les variables dans la base 2021

cat("Variables dans la base 2018 :\n")
for (var in vars_2018) {
  cat(var, "\n")}

cat("\nVariables dans la base 2021 :\n")
for (var in vars_2021) {
  cat(var, "\n")}

```


###**Identifications des variables des deux base des donnees**

Nous identifions les variables qui sont communes aux deux bases et celles qui sont specifiques a chacune des deux bases, cela nous permet d'avoir une id√©e de comment s'y prendre pour l'harmonisation des deux bases pour la fusion.
```{r}
# Identification des variables communes entre les deux bases de donn√©es
vars_com <- dplyr::intersect(vars_2018, vars_2021)

# Identification des variables sp√©cifiques √† chaque base
vars_uniq_welf2018 <- dplyr::setdiff(vars_2018, vars_com)
vars_uniq_welf2021 <- dplyr::setdiff(vars_2021, vars_com)

# Affichage
cat("Variables communes :\n")
print(vars_com)

cat("\nVariables sp√©cifiques √† la base 2018 :\n")
print(vars_uniq_welf2018)

cat("\nVariables sp√©cifiques √† la base 2021 :\n")
print(vars_uniq_welf2021)
```
Nous constatons que toutes les variables presentes en 2018 sont egalement presentes en 2021 a l'exception de la variable "alphab". Par contre il y a 13 nouvelles en 2021 qui ne sont pas presents en 2018.



# Traitement des bases de donn√©es

Apr√®s identification des variables des deux bases de donn√©es ont constate des variables communes mais aussi des variables specifiques a chacune des bases. Pour la suite du travail il nous faut nous assurer de la coherence des deux bases de donn√©es pour pouvoir faire le merge. Pour cela nous allons proceder au recodage, la labelisation, et l'harmonisation de certaines variables.

De prime a bord nous constatons que la varaible "halfab" en 2018 et "halfa" en 2021 represente la meme variable c'est a dire alphabetisation du chef de menage. Nous allons donc proced√© √† l'uniformisation de variable en le renommant en fonction du nom dans l'une des bases

```{r}
# Renommons la variable halpha en halphab dans la base 2021
vars_2021[vars_2021== "halfa"]<- "halfab"
vars_2021

#Ajoutons cette variable a la liste des variables communes 
vars_com <- append(vars_com, "halfab")
vars_com
```


## *Traitement des variables communes mais avec des labels differents dans les deux bases*

###**Verification des variables communes avec des labels differents**
Le code ci-apr√®s permet de v√©rifier si les labels des variables communes entre les bases 2018 et 2021 sont identiques ou non. Il cr√©e une liste des variables dont les labels diff√®rent entre les deux bases. Donc Apr√®s ex√©cution, l'objet "vars_label_diff" contient les variables dont les labels sont diff√©rents entre les deux bases.

```{r}
vars_label_diff <- c() #cr√©er une liste vide 

for (variable in vars_com) { #parcourir les variables en communs dans les deux bases
  
  if(labelled::is.labelled(data_welf2018[[variable]])){ #v√©rifier si la variable en 2018 est lab√©liser
    
      value_label_2018 <- labelled::val_labels(data_welf2018[[variable]]) #recup√©rer les labels de la variable en 2018

  }else{
      value_label_2018 <- NULL #Mettre vide dans le cas ou la variable en 2018 n'est pas lab√©liser
  }
  
if(labelled::is.labelled(data_welf2021[[variable]])){ #v√©rifier si la variable en 2021 est lab√©liser
    
      value_label_2021 <- labelled::val_labels(data_welf2021[[variable]]) #recup√©rer les labels de la variable en 2021
  
  }else{
    
      value_label_2021 <- NULL #Mettre vide dans le cas ou la variable en 2021 n'est pas lab√©liser
  }
  
  if(!identical(value_label_2018, value_label_2021)){ #V√©rifier si les labels de la variable  sont identiques entre 2018 et 2021
vars_label_diff <- append(vars_label_diff,variable) #Si les labels diff√®rent, alors ajouter le nom de la variable √† la liste cr√©er
     print(variable)
     
   }
}
```
Apr√®s execution nous aons liste de 7 variables dont les labels diff√®rent entre les deux bases. Pour faire le merge il faut harmoniser les labels de ces variables dans les deux bases. Cela fera l'objet de la suite de notre travail.


###**Traitement des incoherences des variables**

Pour chaque variable, nous allons:
 - Visualiser la distibution 
 - D√©tecter l'incoh√©rence
 - Corriger l'incoh√©rence
 - Revisualiser la variable pour s'assurer que le traitement n'a pas modifi√© la distribution
 

### * Traitement de la variable "zae"

####**Visualisation de la distribution**
```{r}

data_welf2018 %>%
  to_factor() %>% # Convertir les variables labellis√©es en facteurs
  select(zae) %>% # S√©lectionner la variable √† afficher
  tbl_summary(
    missing = "always", # Afficher les valeurs manquantes
    missing_text = "Valeurs manquantes"
  ) %>%
  modify_header(label ~ "**Taille de l'√©chantillon**") %>% 
  as_gt() %>%  # Conversion en tableau GT
  gt::tab_header(title = "R√©partition des zones agro√©cologiques") %>% 
  gt::tab_source_note(source_note = "Source : EHCVM 2018 (SEN)") %>% 
  gt::tab_options(
    heading.title.font.size = 16,
    heading.title.font.weight = "bold"
  )

```

####**Detection de l'incoherence**
Nous affichons les labels de la variales dans les deux bases pour voir l'incoherence
```{r}

cat("Labels de la variable 'zae' dans la base 2018 :\n")
print(labelled::val_labels(data_welf2018$zae))

cat("\nLabels de la variable 'zae' dans la base 2021 :\n")
print(labelled::val_labels(data_welf2021$zae))

```

####**Correction de l'incoherence**
Nous recodons et appliquons les labels √† la variable zae dans 2018 pour s'assurerer de la coherence avec la base 2021
```{r}
# Recodage de la variable zae
data_welf2018 <- data_welf2018 %>%
  mutate(
    zae = case_when(
      zae == 6 ~ 1,   # K√©dougou
      zae == 2 ~ 3,   # Saint-Louis-Matam
      zae == 3 ~ 5,   # Thies-Diourbel-Louga
      zae == 4 ~ 7,   # Kaolack-Fatick-Kaffrine
      zae == 5 ~ 9,   # Ziguinchor-Tamba-Kolda-S√©dhiou
      zae == 1 ~ 11,  # Dakar
      TRUE ~ NA_real_  # Toutes les autres valeurs deviennent NA
    ))

# Appliquer les labels √† la variable zae
data_welf2018$zae <- labelled(
  data_welf2018$zae,
  labels = c(
    "K√©dougou" = 1, 
    "Saint-Louis-Matam" = 3, 
    "Thies-Diourbel-Louga" = 5,
    "Kaolack-Fatick-Kaffrine" = 7,
    "Ziguinchor-Tamba-Kolda-S√©dhiou" = 9,
    "Dakar" = 11
  ))

# Appliquer les labels √† la variable zae
data_welf2021$zae <- labelled(
  data_welf2021$zae,
  labels = c(
    "K√©dougou" = 1, 
    "Saint-Louis-Matam" = 3, 
    "Thies-Diourbel-Louga" = 5,
    "Kaolack-Fatick-Kaffrine" = 7,
    "Ziguinchor-Tamba-Kolda-S√©dhiou" = 9,
    "Dakar" = 11
  ))
```


####**Revisualisons la distribution apres la correction**
```{r}
# Affichage des tableaux
table_2018<-data_welf2018 %>%
  mutate(zae = to_factor(zae)) %>% # Convertir en facteur si n√©cessaire
  select(zae) %>% # S√©lectionner la variable
  tbl_summary(
    missing = "always", # Afficher les valeurs manquantes
    missing_text = "Valeurs manquantes"
  ) %>%
  modify_header(label ~ "**Taille de l'√©chantillon**") %>% 
  as_gt() %>%  # Convertir en tableau GT
  gt::tab_header(title = "R√©partition des zones agro√©cologiques") %>% 
  gt::tab_source_note(source_note = "Source : EHCVM 2018 (SEN)") %>% 
  gt::tab_options(
    heading.title.font.size = 16,
    heading.title.font.weight = "bold"
  )

# Affichage du tableau
table_2018

```
Nous voyons que les distributions restent les memes apr√®s la correction.



### * Traitement de la variable "hnation"

####**Visualisation de la distribution**
```{r}
# Visualisation dans la base 2018
table_2018<-data_welf2018 %>%
  mutate(hnation = to_factor(hnation)) %>% # Convertir en facteur si n√©cessaire
  select(hnation) %>% # S√©lectionner la variable
  tbl_summary(
    missing = "always", # Afficher les valeurs manquantes
    missing_text = "Valeurs manquantes"
  ) %>%
  modify_header(label ~ "**Taille de l'√©chantillon**") %>% 
  as_gt() %>%  
  gt::tab_header(title = "Nationalit√© du chef de m√©nage (EHCVM 2018)") %>% 
  gt::tab_source_note(source_note = "Source : EHCVM 2018 (SEN)") %>% 
  gt::tab_options(
    heading.title.font.size = 16,
    heading.title.font.weight = "bold"
  )

# Visualisation dans la base 2021
table_2021<-data_welf2021 %>%
  mutate(hnation = to_factor(hnation)) %>% # Convertir en facteur si n√©cessaire
  select(hnation) %>% # S√©lectionner la variable
  tbl_summary(
    missing = "always", # Afficher les valeurs manquantes
    missing_text = "Valeurs manquantes"
  ) %>%
  modify_header(label ~ "**Taille de l'√©chantillon**") %>% 
  as_gt() %>%  
  gt::tab_header(title = "Nationalit√© du chef de m√©nage (EHCVM 2021)") %>% 
  gt::tab_source_note(source_note = "Source : EHCVM 2021 (SEN)") %>% 
  gt::tab_options(
    heading.title.font.size = 16,
    heading.title.font.weight = "bold"
  )

# Affichage des tableaux
table_2018
table_2021

```


####**Detection de l'incoherence**
Nous affichons les labels de la variales dans les deux bases pour voir l'incoherence
```{r}

cat("Labels de la variable 'hnation' dans la base 2018 :\n")
print(labelled::val_labels(data_welf2018$hnation))

cat("\nLabels de la variable 'hnation' dans la base 2021 :\n")
print(labelled::val_labels(data_welf2021$hnation))

```
Nous constatons don des incoherences des labels de la varaiable hnation dans les deux baeses, nottament l'orthographe des labels, la pr√©sence de nouvelles modilit√©s en 2021 et absents en 2018. Il y a egalement des incoherences au niveau des codes


####**Correction des incoherences**
```{r}
# Recodage de la variable hnation
data_welf2021 <- data_welf2021 %>%
  mutate(hnation = case_when(
    hnation == 1  ~ 1,   # B√©nin -> Benin
    hnation == 2  ~ 2,   # Burkina Faso -> Burkina Faso
    hnation == 4  ~ 3,   # Cote d'Ivoire -> C√¥te d'Ivoire
    hnation == 8  ~ 4,   # Guin√©e Bissau -> Guin√©e Bissau
    hnation == 10 ~ 5,   # Mali -> Mali
    hnation == 11 ~ 6,   # Niger -> Niger
    hnation == 13 ~ 7,   # S√©n√©gal -> S√©n√©gal
    hnation == 15 ~ 8,   # Togo -> Togo
    hnation == 12 ~ 9,   # Nigeria -> Nig√©ria
    hnation %in% c(3, 5, 6, 7, 14) ~ 10,  # Cape-vert, Gambie, Ghana, Guin√©e, Sierra Leone -> Autre CEDEAO
    hnation == 17 ~ 11,  # Autre Afrique -> Autre Afrique
    hnation == 18 ~ 12,  # Autre pays hors Afrique -> Autre pays hors Afrique
    TRUE ~ NA_real_  # Toutes les autres valeurs deviennent NA
  ))

# Appliquer les labels √† la variable hnation
data_welf2018$hnation <- labelled(
  data_welf2018$hnation,
  labels = c(
    "Benin" = 1, 
    "Burkina Faso" = 2, 
    "C√¥te d'Ivoire" = 3, 
    "Guin√©e Bissau" = 4,
    "Mali" = 5, 
    "Niger" = 6, 
    "S√©n√©gal" = 7, 
    "Togo" = 8, 
    "Nig√©ria" = 9,
    "Autre CEDEAO" = 10, 
    "Autre Afrique" = 11, 
    "Autre pays hors Afrique" = 12
  ))

# Appliquer les labels √† la variable hnation
data_welf2021$hnation <- labelled(
  data_welf2021$hnation,
  labels = c(
    "Benin" = 1, 
    "Burkina Faso" = 2, 
    "C√¥te d'Ivoire" = 3, 
    "Guin√©e Bissau" = 4,
    "Mali" = 5, 
    "Niger" = 6, 
    "S√©n√©gal" = 7, 
    "Togo" = 8, 
    "Nig√©ria" = 9,
    "Autre CEDEAO" = 10, 
    "Autre Afrique" = 11, 
    "Autre pays hors Afrique" = 12
  ))
```
 
  
####**Revisualisation des distribtions apres correction**
```{r}
# Visualisation dans la base 2018
table_2018<-data_welf2018 %>%
  mutate(hnation = to_factor(hnation)) %>% # Convertir en facteur si n√©cessaire
  select(hnation) %>% # S√©lectionner la variable
  tbl_summary(
    missing = "always", # Afficher les valeurs manquantes
    missing_text = "Valeurs manquantes"
  ) %>%
  modify_header(label ~ "**Taille de l'√©chantillon**") %>% 
  as_gt() %>%  
  gt::tab_header(title = "Nationalit√© du chef de m√©nage (EHCVM 2018)") %>% 
  gt::tab_source_note(source_note = "Source : EHCVM 2018 (SEN)") %>% 
  gt::tab_options(
    heading.title.font.size = 16,
    heading.title.font.weight = "bold"
  )

# Visualisation dans la base 2021
table_2021<-data_welf2021 %>%
  mutate(hnation = to_factor(hnation)) %>% # Convertir en facteur si n√©cessaire
  select(hnation) %>% # S√©lectionner la variable
  tbl_summary(
    missing = "always", # Afficher les valeurs manquantes
    missing_text = "Valeurs manquantes"
  ) %>%
  modify_header(label ~ "**Taille de l'√©chantillon**") %>% 
  as_gt() %>%  
  gt::tab_header(title = "Nationalit√© du chef de m√©nage (EHCVM 2021)") %>% 
  gt::tab_source_note(source_note = "Source : EHCVM 2021 (SEN)") %>% 
  gt::tab_options(
    heading.title.font.size = 16,
    heading.title.font.weight = "bold"
  )

# Affichage des tableaux
table_2018
table_2021

```


### * Traitement de la variable "hdiploma"

####**Visualisation de la distribution**
```{r}
# Visualisation dans la base 2018
table_2018 <- data_welf2018 %>%
  mutate(hdiploma = to_factor(hdiploma)) %>% # Convertir en facteur si n√©cessaire
  select(hdiploma) %>% # S√©lectionner la variable
  tbl_summary(
    missing = "always", # Afficher les valeurs manquantes
    missing_text = "Valeurs manquantes"
  ) %>%
  modify_header(label ~ "**Taille de l'√©chantillon**") %>% 
  as_gt() %>%  
  gt::tab_header(title = "Dipl√¥me du chef de m√©nage (EHCVM 2018)") %>% 
  gt::tab_source_note(source_note = "Source : EHCVM 2018 (SEN)") %>% 
  gt::tab_options(
    heading.title.font.size = 16,
    heading.title.font.weight = "bold"
  )

# Visualisation dans la base 2021
table_2021 <- data_welf2021 %>%
  mutate(hdiploma = to_factor(hdiploma)) %>% # Convertir en facteur si n√©cessaire
  select(hdiploma) %>% # S√©lectionner la variable
  tbl_summary(
    missing = "always", # Afficher les valeurs manquantes
    missing_text = "Valeurs manquantes"
  ) %>%
  modify_header(label ~ "**Taille de l'√©chantillon**") %>% 
  as_gt() %>%  
  gt::tab_header(title = "Dipl√¥me du chef de m√©nage (EHCVM 2021)") %>% 
  gt::tab_source_note(source_note = "Source : EHCVM 2021 (SEN)") %>% 
  gt::tab_options(
    heading.title.font.size = 16,
    heading.title.font.weight = "bold"
  )

# Affichage des tableaux
table_2018
table_2021

```


####**Detection de l'incoherence**
Nous affichons les labels de la variales dans les deux bases pour voir l'incoherence
```{r}

cat("Labels de la variable 'hdiploma' dans la base 2018 :\n")
print(labelled::val_labels(data_welf2018$hdiploma))

cat("\nLabels de la variable 'hdiploma' dans la base 2021 :\n")
print(labelled::val_labels(data_welf2021$hdiploma))

```
Nous constatons don des incoherences des labels de la varaiable hnation dans les deux baeses.


####**Correction des incoh√©rences**
Ici leslabels sont codifi√©s de la meme maniere nous allons donc proceder a l'uniformisation de l'ortographe des labels
```{r}
data_welf2021$hdiploma <- labelled(
  data_welf2021$hdiploma,
  labels = c(
    "Aucun"       = 0, 
    "CEPE"    = 1,
    "BEPC"   = 2,
    "CAP"         = 3,
    "BT"          = 4,
    "BAC"         = 5,
    "DEUG/DUT/BTS"= 6,
    "Licence"     = 7,
    "Maitrise"    = 8,
    "Master/DEA/DESS" = 9,
    "Doctorat/PHD"    = 10
  ),
  label = "Dipl√¥me du chef de m√©nage"
)

data_welf2018$hdiploma <- labelled(
  data_welf2018$hdiploma,
  labels = c(
    "Aucun"       = 0, 
    "CEPE"    = 1,
    "BEPC"   = 2,
    "CAP"         = 3,
    "BT"          = 4,
    "BAC"         = 5,
    "DEUG/DUT/BTS"= 6,
    "Licence"     = 7,
    "Maitrise"    = 8,
    "Master/DEA/DESS" = 9,
    "Doctorat/PHD"    = 10 
  ),
  label = "Dipl√¥me du chef de m√©nage"
)
```


####**Revisualisation de la distribution apres correction**
```{r}
# Visualisation dans la base 2018
table_2018 <- data_welf2018 %>%
  mutate(hdiploma = to_factor(hdiploma)) %>% # Convertir en facteur
  select(hdiploma) %>% # S√©lectionner la variable
  tbl_summary(
    missing = "always", # Afficher les valeurs manquantes
    missing_text = "Valeurs manquantes"
  ) %>%
  modify_header(label ~ "**Taille de l'√©chantillon**") %>% 
  as_gt() %>%  
  gt::tab_header(title = "Dipl√¥me du chef de m√©nage (EHCVM 2018)") %>% 
  gt::tab_source_note(source_note = "Source : EHCVM 2018 (SEN)") %>% 
  gt::tab_options(
    heading.title.font.size = 16,
    heading.title.font.weight = "bold"
  )

# Visualisation dans la base 2021
table_2021 <- data_welf2021 %>%
  mutate(hdiploma = to_factor(hdiploma)) %>% # Convertir en facteur
  select(hdiploma) %>% # S√©lectionner la variable
  tbl_summary(
    missing = "always", # Afficher les valeurs manquantes
    missing_text = "Valeurs manquantes"
  ) %>%
  modify_header(label ~ "**Taille de l'√©chantillon**") %>% 
  as_gt() %>%  
  gt::tab_header(title = "Dipl√¥me du chef de m√©nage (EHCVM 2021)") %>% 
  gt::tab_source_note(source_note = "Source : EHCVM 2021 (SEN)") %>% 
  gt::tab_options(
    heading.title.font.size = 16,
    heading.title.font.weight = "bold"
  )

# Affichage des tableaux
table_2018
table_2021

```



### Traitement de la variable "hactivi7j"

####**Visualisation de la distribution**
```{r}
# Visualisation dans la base 2018
table_2018 <- data_welf2018 %>%
  mutate(hactiv7j = to_factor(hactiv7j)) %>% # Convertir en facteur
  select(hactiv7j) %>% # S√©lectionner la variable
  tbl_summary(
    missing = "always", # Afficher les valeurs manquantes
    missing_text = "Valeurs manquantes"
  ) %>%
  modify_header(label ~ "**Taille de l'√©chantillon**") %>% 
  as_gt() %>%  
  gt::tab_header(title = "Activit√© des 7 derniers jours (EHCVM 2018)") %>% 
  gt::tab_source_note(source_note = "Source : EHCVM 2018 (SEN)") %>% 
  gt::tab_options(
    heading.title.font.size = 16,
    heading.title.font.weight = "bold"
  )

# Visualisation dans la base 2021
table_2021 <- data_welf2021 %>%
  mutate(hactiv7j = to_factor(hactiv7j)) %>% # Convertir en facteur
  select(hactiv7j) %>% # S√©lectionner la variable
  tbl_summary(
    missing = "always", # Afficher les valeurs manquantes
    missing_text = "Valeurs manquantes"
  ) %>%
  modify_header(label ~ "**Taille de l'√©chantillon**") %>% 
  as_gt() %>%  
  gt::tab_header(title = "Activit√© des 7 derniers jours (EHCVM 2021)") %>% 
  gt::tab_source_note(source_note = "Source : EHCVM 2021 (SEN)") %>% 
  gt::tab_options(
    heading.title.font.size = 16,
    heading.title.font.weight = "bold"
  )

# Affichage des tableaux
table_2018
table_2021


```


####**Detection de l'incoherence**
Nous affichons les labels de la variales dans les deux bases pour voir l'incoherence
```{r}

cat("Labels de la variable 'hactiv7j' dans la base 2018 :\n")
print(labelled::val_labels(data_welf2018$hactiv7j))

cat("\nLabels de la variable 'hactiv7j' dans la base 2021 :\n")
print(labelled::val_labels(data_welf2021$hactiv7j))

```
Nous constatons don des incoherences des labels de la varaiable hnation dans les deux baeses.


####**Correction des incoherences**
```{r}
data_welf2018$hactiv7j <- labelled(
  data_welf2018$hactiv7j,
  labels = c(
    "Occup√©" = 1,
    "Ch√¥meur" = 2, 
    "TF cherchant un emploi" = 3,
    "TF ne cherchant pas un emploi"= 4,
    "Inactif"      = 5,
    "Moins de 5 ans"= 6
),
label = "Activit√© 7 jours du CM"
  )

data_welf2021$hactiv7j <- labelled(
  data_welf2021$hactiv7j,
  labels = c(
    "Occup√©" = 1,
    "Ch√¥meur" = 2, 
    "TF cherchant un emploi" = 3,
    "TF ne cherchant pas un emploi"= 4,
    "Inactif"      = 5,
    "Moins de 5 ans"= 6
),
  label = "Activit√© 7 jours du CM"
)
```


####**Revisualisation de la distribution apres correction**
```{r}
# Visualisation dans la base 2018
table_2018 <- data_welf2018 %>%
  mutate(hactiv7j = to_factor(hactiv7j)) %>% # Convertir en facteur
  select(hactiv7j) %>% # S√©lectionner la variable
  tbl_summary(
    missing = "always", # Afficher les valeurs manquantes
    missing_text = "Valeurs manquantes"
  ) %>%
  modify_header(label ~ "**Taille de l'√©chantillon**") %>% 
  as_gt() %>%  
  gt::tab_header(title = "Activit√© des 7 derniers jours (EHCVM 2018)") %>% 
  gt::tab_source_note(source_note = "Source : EHCVM 2018 (SEN)") %>% 
  gt::tab_options(
    heading.title.font.size = 16,
    heading.title.font.weight = "bold"
  )

# Visualisation dans la base 2021
table_2021 <- data_welf2021 %>%
  mutate(hactiv7j = to_factor(hactiv7j)) %>% # Convertir en facteur
  select(hactiv7j) %>% # S√©lectionner la variable
  tbl_summary(
    missing = "always", # Afficher les valeurs manquantes
    missing_text = "Valeurs manquantes"
  ) %>%
  modify_header(label ~ "**Taille de l'√©chantillon**") %>% 
  as_gt() %>%  
  gt::tab_header(title = "Activit√© des 7 derniers jours (EHCVM 2021)") %>% 
  gt::tab_source_note(source_note = "Source : EHCVM 2021 (SEN)") %>% 
  gt::tab_options(
    heading.title.font.size = 16,
    heading.title.font.weight = "bold"
  )

# Affichage des tableaux
table_2018
table_2021

```


### * Traitement de la variable "hcsp"

####**Visualisation de la distribution**
```{r}
# Visualisation dans la base 2018
table_2018 <- data_welf2018 %>%
  mutate(hcsp = to_factor(hcsp)) %>% # Convertir en facteur
  select(hcsp) %>% # S√©lectionner la variable
  tbl_summary(
    missing = "always", # Afficher les valeurs manquantes
    missing_text = "Valeurs manquantes"
  ) %>%
  modify_header(label ~ "**Taille de l'√©chantillon**") %>% 
  as_gt() %>%  
  gt::tab_header(title = "Cat√©gorie socio-professionnelle du chef de m√©nage(EHCVM 2018)") %>% 
  gt::tab_source_note(source_note = "Source : EHCVM 2018 (SEN)") %>% 
  gt::tab_options(
    heading.title.font.size = 16,
    heading.title.font.weight = "bold"
  )

# Visualisation dans la base 2021
table_2021 <- data_welf2021 %>%
  mutate(hcsp = to_factor(hcsp)) %>% # Convertir en facteur
  select(hcsp) %>% # S√©lectionner la variable
  tbl_summary(
    missing = "always", # Afficher les valeurs manquantes
    missing_text = "Valeurs manquantes"
  ) %>%
  modify_header(label ~ "**Taille de l'√©chantillon**") %>% 
  as_gt() %>%  
  gt::tab_header(title = "Cat√©gorie socio-professionnelle du chef de m√©nage(EHCVM 2021)") %>% 
  gt::tab_source_note(source_note = "Source : EHCVM 2021 (SEN)") %>% 
  gt::tab_options(
    heading.title.font.size = 16,
    heading.title.font.weight = "bold"
  )

# Affichage des tableaux
table_2018
table_2021

```


####**Detection de l'incoherence**
Nous affichons les labels de la variales dans les deux bases pour voir l'incoherence
```{r}

cat("Labels de la variable 'hcsp' dans la base 2018 :\n")
print(labelled::val_labels(data_welf2018$hcsp))

cat("\nLabels de la variable 'hcsp' dans la base 2021 :\n")
print(labelled::val_labels(data_welf2021$hcsp))

```
Nous constatons don des incoherences des labels de la varaiable hnation dans les deux baeses.


####**Correction des incoherences**
Nous cosntatons que la variable a les memes codes dans les deux bases. Les incoherence se situent au niveau de l'orthographe des labels. Nous allons donc affecter les labels de la variable en 2021 a la variable en 2018
```{r}
val_labels(data_welf2018$hcsp) <-  val_labels(data_welf2021$hcsp)
```


####**Revisualisation de la distribution apres correction**
```{r}
# Visualisation dans la base 2018
table_2018 <- data_welf2018 %>%
  mutate(hcsp = to_factor(hcsp)) %>% # Convertir en facteur
  select(hcsp) %>% # S√©lectionner la variable
  tbl_summary(
    missing = "always", # Afficher les valeurs manquantes
    missing_text = "Valeurs manquantes"
  ) %>%
  modify_header(label ~ "**Taille de l'√©chantillon**") %>% 
  as_gt() %>%  
  gt::tab_header(title = "Cat√©gorie socio-professionnelle du chef de m√©nage(EHCVM 2018)") %>% 
  gt::tab_source_note(source_note = "Source : EHCVM 2018 (SEN)") %>% 
  gt::tab_options(
    heading.title.font.size = 16,
    heading.title.font.weight = "bold"
  )

# Visualisation dans la base 2021
table_2021 <- data_welf2021 %>%
  mutate(hcsp = to_factor(hcsp)) %>% # Convertir en facteur
  select(hcsp) %>% # S√©lectionner la variable
  tbl_summary(
    missing = "always", # Afficher les valeurs manquantes
    missing_text = "Valeurs manquantes"
  ) %>%
  modify_header(label ~ "**Taille de l'√©chantillon**") %>% 
  as_gt() %>%  
  gt::tab_header(title = "Cat√©gorie socio-professionnelle du chef de m√©nage(EHCVM 2021)") %>% 
  gt::tab_source_note(source_note = "Source : EHCVM 2021 (SEN)") %>% 
  gt::tab_options(
    heading.title.font.size = 16,
    heading.title.font.weight = "bold"
  )

# Affichage des tableaux
table_2018
table_2021

```



### * Traitement de la variable "hbranch"

#### **Visualisation de la distribution**
```{r}
# Visualisation dans la base 2018
table_2018 <- data_welf2018 %>%
  mutate(hbranch = to_factor(hbranch)) %>% # Convertir en facteur
  select(hbranch) %>% # S√©lectionner la variable
  tbl_summary(
    missing = "always", # Afficher les valeurs manquantes
    missing_text = "Valeurs manquantes"
  ) %>%
  modify_header(label ~ "**Taille de l'√©chantillon**") %>% 
  as_gt() %>%  
  gt::tab_header(title = "Branche d'activit√© du chef de m√©nage (EHCVM 2018)") %>% 
  gt::tab_source_note(source_note = "Source : EHCVM 2018 (SEN)") %>% 
  gt::tab_options(
    heading.title.font.size = 16,
    heading.title.font.weight = "bold"
  )

# Visualisation dans la base 2021
table_2021 <- data_welf2021 %>%
  mutate(hbranch = to_factor(hbranch)) %>% # Convertir en facteur
  select(hbranch) %>% # S√©lectionner la variable
  tbl_summary(
    missing = "always", # Afficher les valeurs manquantes
    missing_text = "Valeurs manquantes"
  ) %>%
  modify_header(label ~ "**Taille de l'√©chantillon**") %>% 
  as_gt() %>%  
  gt::tab_header(title = "Branche d'activit√© du chef de m√©nage (EHCVM 2021)") %>% 
  gt::tab_source_note(source_note = "Source : EHCVM 2021 (SEN)") %>% 
  gt::tab_options(
    heading.title.font.size = 16,
    heading.title.font.weight = "bold"
  )

# Affichage des tableaux
table_2018
table_2021

```


####**Detection de l'incoherence**
Nous affichons les labels de la variales dans les deux bases pour voir l'incoherence
```{r}

cat("Labels de la variable 'hbranch' dans la base 2018 :\n")
print(labelled::val_labels(data_welf2018$hbranch))

cat("\nLabels de la variable 'hbranch' dans la base 2021 :\n")
print(labelled::val_labels(data_welf2021$hbranch))

```
Nous constatons don des incoherences des labels de la varaiable hnation dans les deux baeses.

Nous cosntatons que la variable est cod√©e de la meme mani√®re dans les deux bases. Les incoherences se situent au niveau de l'orthographe des labels. Nous allons donc affecter les labels de la variable en 2021 a la variable en 2018
```{r}
val_labels(data_welf2018$hbranch) <-  val_labels(data_welf2021$hbranch)
```


####**Revisualisation de la distribution apres correction**
```{r}
# Visualisation dans la base 2018
table_2018 <- data_welf2018 %>%
  mutate(hbranch = to_factor(hbranch)) %>% # Convertir en facteur
  select(hbranch) %>% # S√©lectionner la variable
  tbl_summary(
    missing = "always", # Afficher les valeurs manquantes
    missing_text = "Valeurs manquantes"
  ) %>%
  modify_header(label ~ "**Taille de l'√©chantillon**") %>% 
  as_gt() %>%  
  gt::tab_header(title = "Branche d'activit√© du chef de m√©nage (EHCVM 2018)") %>% 
  gt::tab_source_note(source_note = "Source : EHCVM 2018 (SEN)") %>% 
  gt::tab_options(
    heading.title.font.size = 16,
    heading.title.font.weight = "bold"
  )

# Visualisation dans la base 2021
table_2021 <- data_welf2021 %>%
  mutate(hbranch = to_factor(hbranch)) %>% # Convertir en facteur
  select(hbranch) %>% # S√©lectionner la variable
  tbl_summary(
    missing = "always", # Afficher les valeurs manquantes
    missing_text = "Valeurs manquantes"
  ) %>%
  modify_header(label ~ "**Taille de l'√©chantillon**") %>% 
  as_gt() %>%  
  gt::tab_header(title = "Branche d'activit√© du chef de m√©nage (EHCVM 2021)") %>% 
  gt::tab_source_note(source_note = "Source : EHCVM 2021 (SEN)") %>% 
  gt::tab_options(
    heading.title.font.size = 16,
    heading.title.font.weight = "bold"
  )

# Affichage des tableaux
table_2018
table_2021

```


### * Traitement de la variable "region"

####**Visualisation de la distribution**
```{r}
# Visualisation dans la base 2018
table_2018 <- data_welf2018 %>%
  mutate(region = to_factor(region)) %>% # Convertir en facteur
  select(region) %>% # S√©lectionner la variable
  tbl_summary(
    missing = "always", # Afficher les valeurs manquantes
    missing_text = "Valeurs manquantes"
  ) %>%
  modify_header(label ~ "**Taille de l'√©chantillon**") %>% 
  as_gt() %>%  
  gt::tab_header(title = "R√©gion de r√©sidence du chef de m√©nage (EHCVM 2018)") %>% 
  gt::tab_source_note(source_note = "Source : EHCVM 2018 (SEN)") %>% 
  gt::tab_options(
    heading.title.font.size = 16,
    heading.title.font.weight = "bold"
  )

# Visualisation dans la base 2021
table_2021 <- data_welf2021 %>%
  mutate(region = to_factor(region)) %>% # Convertir en facteur
  select(region) %>% # S√©lectionner la variable
  tbl_summary(
    missing = "always", # Afficher les valeurs manquantes
    missing_text = "Valeurs manquantes"
  ) %>%
  modify_header(label ~ "**Taille de l'√©chantillon**") %>% 
  as_gt() %>%  
  gt::tab_header(title = "R√©gion de r√©sidence du chef de m√©nage (EHCVM 2021)") %>% 
  gt::tab_source_note(source_note = "Source : EHCVM 2021 (SEN)") %>% 
  gt::tab_options(
    heading.title.font.size = 16,
    heading.title.font.weight = "bold"
  )

# Affichage des tableaux
table_2018
table_2021

```


####**Detection de l'incoherence**
Nous affichons les labels de la variales dans les deux bases pour voir l'incoherence
```{r}

cat("Labels de la variable 'region' dans la base 2018 :\n")
print(labelled::val_labels(data_welf2018$region))

cat("\nLabels de la variable 'region' dans la base 2021 :\n")
print(labelled::val_labels(data_welf2021$region))

```
Nous constatons don des incoherences des labels de la varaiable hnation dans les deux bases.

####**Correction des incoherences**
Nous cosntatons que la variable est cod√©e de la meme mani√®re dans les deux bases. Les incoherences se situent au niveau de l'orthographe des labels. Nous allons donc affecter les labels de la variable en 2018 a la variable en 2021
```{r}
val_labels(data_welf2021$region) <-  val_labels(data_welf2018$region)
```


####**Revisualisation de la distribution apres correction**
```{r}
# Visualisation dans la base 2018
table_2018 <- data_welf2018 %>%
  mutate(region = to_factor(region)) %>% # Convertir en facteur
  select(region) %>% # S√©lectionner la variable
  tbl_summary(
    missing = "always", # Afficher les valeurs manquantes
    missing_text = "Valeurs manquantes"
  ) %>%
  modify_header(label ~ "**Taille de l'√©chantillon**") %>% 
  as_gt() %>%  
  gt::tab_header(title = "R√©gion de r√©sidence du chef de m√©nage (EHCVM 2018)") %>% 
  gt::tab_source_note(source_note = "Source : EHCVM 2018 (SEN)") %>% 
  gt::tab_options(
    heading.title.font.size = 16,
    heading.title.font.weight = "bold"
  )

# Visualisation dans la base 2021
table_2021 <- data_welf2021 %>%
  mutate(region = to_factor(region)) %>% # Convertir en facteur
  select(region) %>% # S√©lectionner la variable
  tbl_summary(
    missing = "always", # Afficher les valeurs manquantes
    missing_text = "Valeurs manquantes"
  ) %>%
  modify_header(label ~ "**Taille de l'√©chantillon**") %>% 
  as_gt() %>%  
  gt::tab_header(title = "R√©gion de r√©sidence du chef de m√©nage (EHCVM 2021)") %>% 
  gt::tab_source_note(source_note = "Source : EHCVM 2021 (SEN)") %>% 
  gt::tab_options(
    heading.title.font.size = 16,
    heading.title.font.weight = "bold"
  )

# Affichage des tableaux
table_2018
table_2021
```



####**Verifions les labels et le recodage apres l'harmonisation des vaeriables qui n'etaient pas conforme dans les deux bases**
```{r}
variables_problemes <- c("zae", "region", "hnation", "hdiploma", "hactiv7j", "hbranch", "hcsp")

for (var in variables_problemes) {
  cat("Variable :", var, "\n")
  cat("Labels 2018 :\n")
  print(labelled::val_labels(data_welf2018[[var]]))
  cat("\nLabels 2021 :\n")
  print(labelled::val_labels(data_welf2021[[var]]))
  cat("\n------------------------------------\n")
}
```


####**Verifionsompare les labels des variables, les labels des valeurs et les types des variables entre deux bases de donn√©e**
```{r}
#Fonction qui compare les labels des variables, les labels des valeurs et les types des variables entre les deux bases

compare_data <- function(df1, df2) {
  vars_com <- intersect(names(df1), names(df2))
  different_labels <- list()
  var_diff_labels <- list()
  type_diff <- list()
  
  for (var in vars_com) {
    # üîπ Comparaison des labels des variables
    label1 <- attr(df1[[var]], "label")
    label2 <- attr(df2[[var]], "label")
    
    if (!identical(label1, label2)) {
      different_labels[[var]] <- list("Label 2018" = label1, "Label 2021" = label2)
    }
    
    # üîπ Comparaison des labels des valeurs des variables labellis√©es
    labels_2018 <- if (labelled::is.labelled(df1[[var]])) labelled::val_labels(df1[[var]]) else NULL
    labels_2021 <- if (labelled::is.labelled(df2[[var]])) labelled::val_labels(df2[[var]]) else NULL
    
    if (!identical(labels_2018, labels_2021)) {
      var_diff_labels[[var]] <- list("Labels 2018" = labels_2018, "Labels 2021" = labels_2021)
    }
    
    # üîπ Comparaison des types des variables
    type1 <- class(df1[[var]])
    type2 <- class(df2[[var]])
    
    if (!identical(type1, type2)) {
      type_diff[[var]] <- list("Type 2018" = type1, "Type 2021" = type2)
    }
  }
  
  # üî• Affichage des r√©sultats
  if (length(different_labels) == 0) {
    print("‚úÖ Les labels des variables sont identiques entre 2018 et 2021.")
  } else {
    print("‚ö†Ô∏è Labels des variables diff√©rents :")
    print(different_labels)
  }
  
  if (length(var_diff_labels) == 0) {
    print("‚úÖ Les labels des valeurs sont identiques entre 2018 et 2021.")
  } else {
    print("‚ö†Ô∏è Labels des valeurs diff√©rents :")
    print(var_diff_labels)
  }
  
  if (length(type_diff) == 0) {
    print("‚úÖ Les types de variables sont identiques entre 2018 et 2021.")
  } else {
    print("‚ö†Ô∏è Variables avec des types diff√©rents :")
    print(type_diff)
  }
}
```

####**Appel de la fonction**
```{r}
compare_data(data_welf2018, data_welf2021)

```


Apres execution du code ci-desssous nosu constatons que les labels des variables "grappe" et "menage ne sont pas les memes dans les deux bases. Nous allons donc les harmoniser.

####** Harmonisation des labels
```{r}
# D√©finir les labels corrects et coh√©rents entre les deux bases
var_labels <- c(
  "grappe" = "Num√©ro grappe",
  "menage" = "Num√©ro m√©nage"
)

# Appliquer les labels √† la base 2018
for (var in names(var_labels)) {
  attr(data_welf2018[[var]], "label") <- var_labels[var]
}

# Appliquer les labels √† la base 2021
for (var in names(var_labels)) {
  attr(data_welf2021[[var]], "label") <- var_labels[var]
}

```

# Fusion des deux bases
```{r}
# Empiler les deux bases apr√®s harmonisation
data_welf_final18_21 <- dplyr::bind_rows(data_welf2018, data_welf2021)
data_welf_final18_21

```

## Quelques statistiques sur la base final
```{r}
data_welf_final18_21 %>%    
  to_factor() %>%  # Conversion des variables haven_labelled en facteurs
  select(year, hage, hgender, hdiploma, hcsp, dtot, dali, halfab) %>% 
  tbl_summary(
    by= year,
    digits = list(hage~ 0, dtot~0, dali~0 ), # Affichage sans d√©cimales pour l'√¢ge, dtot et dali
    missing = "always",
    missing_text = "Valeurs manquantes"
  ) %>% 
  modify_header(label ~ "**Taille des √©chantillons**") %>% 
  as_gt() %>%
  gt::tab_header(title = "Statistiques sur certaines variables apr√®s fusion") %>% 
  gt::tab_source_note(source_note = "Source : EHCVM 2018 et 2021 (SEN)") %>%
  gt::tab_options(
    heading.title.font.size = 20,
    heading.title.font.weight = "bold"
  )

```


## Sauvegarde de la base final
```{r}
# Sauvegarde au format Stata
write_dta(data_welf_final18_21, "data_welf_final18_21.dta")

```





